<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>Geometric Dump Sequence Generator | MD Simulation Tool</title>
    <meta name="title" content="Geometric Dump Sequence Generator | MD Simulation Tool">
    <meta name="description" content="Generate geometrically-spaced dump sequences for molecular dynamics simulations of glassy systems. Efficiently capture dynamics across multiple decades of time with logarithmic spacing.">
    <meta name="keywords" content="molecular dynamics, MD simulation, glassy systems, geometric dumping, logarithmic time spacing, tau alpha, relaxation time, aging dynamics, time-translation invariance, LAMMPS, trajectory analysis">
    <meta name="author" content="Collin Collins, Max, Claude">
    <meta name="robots" content="index, follow">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <!-- Open Graph / Social -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Geometric Dump Sequence Generator">
    <meta property="og:description" content="Generate geometrically-spaced dump sequences for molecular dynamics simulations. Capture dynamics across multiple decades of time with efficient logarithmic spacing.">
    <meta property="og:image" content="favicon.png">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Geometric Dump Sequence Generator">
    <meta name="twitter:description" content="Generate geometrically-spaced dump sequences for molecular dynamics simulations of glassy systems.">
    
    <!-- Schema.org structured data for scientific software -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "Geometric Dump Sequence Generator",
        "applicationCategory": "Scientific Software",
        "operatingSystem": "Web Browser",
        "description": "Interactive tool for generating geometrically-spaced dump sequences for molecular dynamics simulations of glassy systems, enabling efficient capture of dynamics across multiple decades of time.",
        "featureList": [
            "Geometric time spacing for MD trajectories",
            "Two-sequence approach (equilibration + production)",
            "Auto-optimization of sequence parameters",
            "DCD file size estimation",
            "Interactive visualization of dump schedules"
        ],
        "softwareHelp": "https://github.com/collincollins/geometric-dump-sequence-generator",
        "isAccessibleForFree": true
    }
    </script>
    
    <!-- Apache ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <!-- JSZip for downloads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- KaTeX for math rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f8f8;
            --bg-tertiary: #f0f0f0;
            --text-primary: #222222;
            --text-secondary: #555555;
            --text-muted: #888888;
            --border-color: #dddddd;
            --border-light: #eeeeee;
            --accent: #2563eb;
            --accent-hover: #1d4ed8;
            --success: #16a34a;
            --success-bg: #dcfce7;
            --error: #dc2626;
            --error-bg: #fee2e2;
            --warning-bg: #fef3c7;
            --code-bg: #f5f5f5;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #242424;
            --bg-tertiary: #2d2d2d;
            --text-primary: #e8e8e8;
            --text-secondary: #b0b0b0;
            --text-muted: #777777;
            --border-color: #3d3d3d;
            --border-light: #333333;
            --accent: #3b82f6;
            --accent-hover: #60a5fa;
            --success: #22c55e;
            --success-bg: #14532d;
            --error: #ef4444;
            --error-bg: #450a0a;
            --warning-bg: #422006;
            --code-bg: #2d2d2d;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Courier New', Consolas, 'Liberation Mono', monospace;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--text-primary);
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-link {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.9em;
            cursor: pointer;
        }
        
        .header-link:hover {
            text-decoration: underline;
        }
        
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .theme-toggle:hover {
            background: var(--border-color);
        }
        
        /* Sections */
        h2 {
            font-size: 1.05em;
            font-weight: 600;
            margin: 25px 0 12px 0;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        
        h3 {
            font-size: 0.95em;
            font-weight: 600;
            margin: 18px 0 10px 0;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .section {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 18px;
            margin-bottom: 18px;
        }
        
        /* Parameter Grid */
        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 18px;
        }
        
        .param-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .param-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .param-label .unit {
            color: var(--text-muted);
            font-size: 0.9em;
        }
        
        .help-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .help-icon:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        .help-content {
            display: none;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            margin-top: 6px;
            font-size: 0.82em;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .help-content.show {
            display: block;
        }
        
        .help-content code {
            background: var(--code-bg);
            padding: 1px 4px;
            font-size: 0.95em;
        }
        
        .param-group input[type="number"],
        .param-group input[type="text"] {
            font-family: inherit;
            font-size: 1em;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .param-group input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .param-group input::placeholder {
            color: var(--text-muted);
        }
        
        /* Advanced Toggle */
        .advanced-toggle {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.9em;
            margin: 15px 0 10px 0;
            user-select: none;
        }
        
        .advanced-toggle:hover {
            color: var(--text-secondary);
        }
        
        .advanced-content {
            display: none;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
            margin-top: 10px;
        }
        
        .advanced-content.show {
            display: block;
        }
        
        /* Buttons */
        .btn {
            font-family: inherit;
            font-size: 0.95em;
            padding: 10px 22px;
            border: 1px solid var(--text-primary);
            background: var(--text-primary);
            color: var(--bg-primary);
            cursor: pointer;
            margin-right: 10px;
            margin-top: 12px;
        }
        
        .btn:hover {
            opacity: 0.85;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        /* Command Box */
        .command-box {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            font-size: 0.88em;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .command-explanation {
            display: none;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-top: none;
            padding: 12px 15px;
            font-size: 0.82em;
            line-height: 1.8;
        }
        
        .command-explanation.show {
            display: block;
        }
        
        .command-explanation .param-line {
            display: flex;
            gap: 20px;
        }
        
        .command-explanation .param-name {
            color: var(--accent);
            min-width: 80px;
        }
        
        .explanation-toggle {
            font-size: 0.8em;
            color: var(--text-muted);
            cursor: pointer;
            margin-top: 5px;
            display: inline-block;
        }
        
        .explanation-toggle:hover {
            color: var(--accent);
        }
        
        /* Reality Checks */
        .reality-checks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 8px;
        }
        
        .check-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            font-size: 0.82em;
        }
        
        .check-item.pass {
            background: var(--success-bg);
            border: 1px solid var(--success);
        }
        
        .check-item.fail {
            background: var(--error-bg);
            border: 1px solid var(--error);
        }
        
        .check-item.pending {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }
        
        .check-icon {
            font-weight: bold;
            width: 18px;
            text-align: center;
        }
        
        .check-item.pass .check-icon { color: var(--success); }
        .check-item.fail .check-icon { color: var(--error); }
        .check-item.pending .check-icon { color: var(--text-muted); }
        
        /* Summary Table */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88em;
            margin: 12px 0;
        }
        
        .summary-table th, .summary-table td {
            padding: 10px 12px;
            text-align: left;
            border: 1px solid var(--border-color);
        }
        
        .summary-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }
        
        .summary-table .right { text-align: right; }
        
        .summary-table .total-row {
            font-weight: 600;
            background: var(--bg-tertiary);
        }
        
        /* Assumptions Box */
        .assumptions-box {
            background: var(--warning-bg);
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            font-size: 0.82em;
            margin: 12px 0;
        }
        
        .assumptions-box strong {
            display: block;
            margin-bottom: 6px;
        }
        
        /* Download Buttons */
        .download-btns {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }
        
        /* Scale Toggle */
        .scale-toggle {
            display: inline-flex;
            gap: 12px;
            font-size: 0.85em;
            font-weight: normal;
        }
        
        .scale-toggle label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        .scale-toggle input[type="radio"] {
            cursor: pointer;
        }
        
        /* Plot Container */
        .plot-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            margin: 12px 0;
            height: 320px;
        }
        
        .plot-note {
            font-size: 0.82em;
            color: var(--text-muted);
            margin: 8px 0;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-left: 3px solid var(--border-color);
        }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            width: 100%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }
        
        .modal-header h2 {
            margin: 0;
            border: none;
            padding: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0 5px;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-tab {
            padding: 12px 20px;
            cursor: pointer;
            background: var(--bg-tertiary);
            border: none;
            font-family: inherit;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .modal-tab.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .modal-content {
            padding: 20px;
        }
        
        .modal-content p {
            margin-bottom: 12px;
        }
        
        .modal-content ul {
            margin: 12px 0 12px 25px;
        }
        
        .modal-content li {
            margin-bottom: 8px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .math-block {
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: var(--bg-tertiary);
            overflow-x: auto;
        }
        
        /* Inline param */
        .inline-param {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .inline-param input {
            width: 120px;
            font-family: inherit;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Geometric Dump Sequence Generator</h1>
            <div class="header-actions">
                <span class="header-link" onclick="openModal()">Why Geometric Dumping?</span>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span id="theme-icon">&#9790;</span>
                    <span id="theme-text">Dark</span>
                </button>
            </div>
        </div>
        
        <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 20px;">
            Generate geometrically-spaced dump sequences for LAMMPS simulations of glassy systems. 
            This tool creates the timing files needed for LAMMPS loops and visualizes the resulting dump schedule.
        </p>
        
        <!-- Required Parameters -->
        <div class="section">
            <h2>Required Parameters</h2>
            <div class="params-grid">
                <div class="param-group">
                    <div class="param-label">
                        timestep (dt) <span class="unit">[LJ]</span>
                        <span class="help-icon" onclick="toggleHelp(this)">?</span>
                    </div>
                    <input type="number" id="dt" value="0.001" step="0.0001" min="0.0001">
                    <div class="help-content">
                        The simulation timestep in LJ (Lennard-Jones) time units. This is the fundamental time resolution of your molecular dynamics simulation. Typical values range from 0.001 to 0.005 LJ.
                    </div>
                </div>
                <div class="param-group">
                    <div class="param-label">
                        tau_equil <span class="unit">[LJ]</span>
                        <span class="help-icon" onclick="toggleHelp(this)">?</span>
                    </div>
                    <input type="text" id="tau_equil" value="200" placeholder="e.g. 100*tau_alpha">
                    <div class="help-content">
                        The equilibration time - the duration of the long sequence during which the system equilibrates. The long sequence will target ending near this time. Typically 10-100x tau_alpha. You can use expressions like <code>100*tau_alpha</code> or <code>20*tau_alpha</code>.
                    </div>
                </div>
                <div class="param-group">
                    <div class="param-label">
                        tau_alpha <span class="unit">[LJ]</span>
                        <span class="help-icon" onclick="toggleHelp(this)">?</span>
                    </div>
                    <input type="number" id="tau_alpha" value="10" step="0.1" min="0.1">
                    <div class="help-content">
                        The alpha relaxation time - the characteristic timescale for structural relaxation in glassy systems. This is typically measured from the decay of self-intermediate scattering functions or mean-squared displacement. Used to set the geometric ratio and short sequence length.
                    </div>
                </div>
                <div class="param-group">
                    <div class="param-label">
                        total_time_long_sequence <span class="unit">[LJ]</span>
                        <span class="help-icon" onclick="toggleHelp(this)">?</span>
                    </div>
                    <input type="text" id="total_time_long" value="" placeholder="tau_equil">
                    <div class="help-content">
                        Target end time for the long sequence. Defaults to <code>tau_equil</code>. The optimal number of terms (n) is auto-selected to get the final dump as close to this value as possible. You can use expressions like <code>0.5*tau_equil</code> or <code>20*tau_alpha</code>.
                    </div>
                </div>
                <div class="param-group">
                    <div class="param-label">
                        total_time_short_sequence <span class="unit">[LJ]</span>
                        <span class="help-icon" onclick="toggleHelp(this)">?</span>
                    </div>
                    <input type="text" id="total_time_short" value="" placeholder="100*tau_alpha">
                    <div class="help-content">
                        Total duration of all short sequences combined. Defaults to <code>100*tau_alpha</code>. This determines how long after equilibration you continue recording. Divided by the short sequence length to get the number of repeats.
                    </div>
                </div>
                <div class="param-group">
                    <div class="param-label">
                        long_sequence_filename
                        <span class="help-icon" onclick="toggleHelp(this)">?</span>
                    </div>
                    <input type="text" id="long_filename_pattern" value="short<n>.dcd" placeholder="short<n>.dcd">
                    <div class="help-content">
                        Filename pattern for long sequence trajectory files. Use <code>&lt;n&gt;</code> as placeholder for the file number. Examples: <code>short&lt;n&gt;.dcd</code>, <code>equil_&lt;n&gt;.dcd</code>, <code>traj_long_&lt;n&gt;.dcd</code>
                    </div>
                </div>
                <div class="param-group">
                    <div class="param-label">
                        short_sequence_filename
                        <span class="help-icon" onclick="toggleHelp(this)">?</span>
                    </div>
                    <input type="text" id="short_filename_pattern" value="short<n>.dcd" placeholder="short<n>.dcd">
                    <div class="help-content">
                        Filename pattern for short sequence trajectory files. Use <code>&lt;n&gt;</code> as placeholder for the file number. Examples: <code>short&lt;n&gt;.dcd</code>, <code>prod_&lt;n&gt;.dcd</code>, <code>traj_short_&lt;n&gt;.dcd</code>
                    </div>
                </div>
            </div>
            
            <!-- Advanced Settings -->
            <div class="advanced-toggle" onclick="toggleAdvanced()">
                <span id="advanced-icon">[+]</span> Advanced Settings (not recommended to change)
            </div>
            <div class="advanced-content" id="advanced-content">
                <div class="params-grid">
                    <div class="param-group">
                        <div class="param-label">
                            dumps_per_short_sequence
                            <span class="help-icon" onclick="toggleHelp(this)">?</span>
                        </div>
                        <input type="number" id="dumps_per_short" value="27" step="1" min="5">
                        <div class="help-content">
                            Target number of dumps per short sequence. Due to rounding (floor function), the actual number may be slightly less. Default of 27 typically yields ~25 actual dumps. Higher values give finer time resolution but more data.
                        </div>
                    </div>
                    <div class="param-group">
                        <div class="param-label">
                            length_of_short_sequence <span class="unit">[LJ]</span>
                            <span class="help-icon" onclick="toggleHelp(this)">?</span>
                        </div>
                        <input type="text" id="length_short" value="" placeholder="0.90*tau_alpha">
                        <div class="help-content">
                            Duration of each individual short sequence. Defaults to <code>0.90*tau_alpha</code>. Set to less than tau_alpha so that tau_alpha falls within a region of high dump density (not at the sparse end of a sequence). This ensures accurate measurement of dynamics at tau_alpha.
                        </div>
                    </div>
                </div>
            </div>
            
            <button class="btn" onclick="generate()">Generate Sequences</button>
            <button class="btn btn-secondary" onclick="resetParams()">Reset to Defaults</button>
        </div>
        
        <!-- Generated Commands -->
        <div class="section" id="commands-section">
            <h2>Generated Commands</h2>
            <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 15px;">
                Run these commands with geo-rev11.py to generate the LAMMPS loop files, or download them directly below.
            </p>
            
            <h3>Long Sequence Command</h3>
            <div class="command-box" id="long-command">--</div>
            <span class="explanation-toggle" onclick="toggleExplanation('long-explanation')">[Show explanation]</span>
            <div class="command-explanation" id="long-explanation"></div>
            
            <h3>Short Sequence Command</h3>
            <div class="command-box" id="short-command">--</div>
            <span class="explanation-toggle" onclick="toggleExplanation('short-explanation')">[Show explanation]</span>
            <div class="command-explanation" id="short-explanation"></div>
        </div>
        
        <!-- Reality Checks -->
        <div class="section" id="checks-section">
            <h2>Reality Checks</h2>
            <div class="reality-checks" id="reality-checks">
                <div class="check-item pending"><span class="check-icon">-</span> Long sequence first filename correct</div>
                <div class="check-item pending"><span class="check-icon">-</span> Long sequence first dump_time == 1</div>
                <div class="check-item pending"><span class="check-icon">-</span> Long sequence first run_time == 1</div>
                <div class="check-item pending"><span class="check-icon">-</span> Short sequence first dump_time == long_last + 1</div>
                <div class="check-item pending"><span class="check-icon">-</span> Short sequence first filename == long_count + 1</div>
                <div class="check-item pending"><span class="check-icon">-</span> Short sequence last dump >= target</div>
            </div>
        </div>
        
        <!-- Summary & Downloads -->
        <div class="section" id="summary-section">
            <h2>Summary &amp; Downloads</h2>
            
            <h3>Estimated Trajectory File Size (from LAMMPS simulation)</h3>
            <div class="inline-param">
                <label>Number of particles:</label>
                <input type="number" id="num_particles" value="100000" step="1000" min="1" onchange="updateFileSizes(); saveParams();">
                <span class="help-icon" onclick="toggleHelp(this)">?</span>
            </div>
            <div class="help-content" id="particles-help" style="max-width: 400px;">
                Total number of particles/atoms in your simulation. Used to estimate file sizes based on DCD trajectory format.
            </div>
            
            <div class="assumptions-box">
                <strong>Note:</strong> This estimates the size of trajectory files (.dcd) that LAMMPS will generate during your simulation - NOT the download buttons below.
                <ul style="margin-left: 20px; margin-top: 8px;">
                    <li>DCD format: 12 bytes per particle per frame (3 floats x 4 bytes for x, y, z)</li>
                    <li>~100 bytes header overhead per frame</li>
                    <li>Formula: size = (12 * particles + 100) * frames</li>
                </ul>
            </div>
            
            <table class="summary-table">
                <tr>
                    <th>Sequence</th>
                    <th class="right">Dumps</th>
                    <th class="right">Timestep Range</th>
                    <th class="right">Time Range (LJ)</th>
                    <th class="right">Est. Trajectory Size</th>
                </tr>
                <tr>
                    <td>Long (Equilibration)</td>
                    <td class="right" id="long-dumps">--</td>
                    <td class="right" id="long-range-ts">--</td>
                    <td class="right" id="long-range-lj">--</td>
                    <td class="right" id="long-size">--</td>
                </tr>
                <tr>
                    <td>Short (Production)</td>
                    <td class="right" id="short-dumps">--</td>
                    <td class="right" id="short-range-ts">--</td>
                    <td class="right" id="short-range-lj">--</td>
                    <td class="right" id="short-size">--</td>
                </tr>
                <tr class="total-row">
                    <td>Total</td>
                    <td class="right" id="total-dumps">--</td>
                    <td></td>
                    <td></td>
                    <td class="right" id="total-size">--</td>
                </tr>
            </table>
            
            <h3>Download LAMMPS Loop Files</h3>
            <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px;">
                These downloads contain small text files (~KB) for use in LAMMPS loops: <code>dump_times.txt</code> (when to dump), 
                <code>run_times.txt</code> (how long to run between dumps), and <code>file_names.txt</code> (output trajectory names).
            </p>
            <div class="download-btns">
                <button class="btn" id="btn-individual" onclick="downloadIndividual()" disabled>Download Individual Files (ZIP)</button>
                <button class="btn" id="btn-stitched" onclick="downloadStitched()" disabled>Download Stitched Files (ZIP)</button>
            </div>
        </div>
        
        <!-- Visualization -->
        <div class="section" id="viz-section">
            <h2>Visualization</h2>
            <p style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 15px;">
                Preview the dump schedule that will be used in your LAMMPS simulation.
            </p>
            
            <h3>
                Dump Times
                <span class="scale-toggle">
                    <label><input type="radio" name="dump-scale" value="linear" checked onchange="updateDumpPlot()"> Linear</label>
                    <label><input type="radio" name="dump-scale" value="log" onchange="updateDumpPlot()"> Log</label>
                </span>
            </h3>
            <div class="plot-note" id="dump-note">On log scale, geometrically spaced points appear linearly spaced.</div>
            <div class="plot-container" id="plot-dump"></div>
            
            <h3>Run Times (Intervals)</h3>
            <div class="plot-container" id="plot-run"></div>
            
            <h3>
                First Two Short Sequences
                <span class="scale-toggle">
                    <label><input type="radio" name="short-scale" value="linear" checked onchange="updateShortPlot()"> Linear</label>
                    <label><input type="radio" name="short-scale" value="log" onchange="updateShortPlot()"> Log</label>
                </span>
            </h3>
            <div class="plot-note">tau_alpha = <span id="tau-display">--</span> LJ marked in green. Each short sequence: <span id="seq-info">--</span> dumps.</div>
            <div class="plot-container" id="plot-short"></div>
        </div>
        
        <footer style="text-align: center; padding: 30px 0 10px; color: var(--text-muted); font-size: 0.85em;">
            Made by Collin, Max, and Claude
        </footer>
    </div>
    
    <!-- Educational Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2>Why Geometric Dumping?</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchTab('basic')">Basic Overview</button>
                <button class="modal-tab" onclick="switchTab('technical')">Technical Explanation</button>
            </div>
            <div class="modal-content">
                <div class="tab-content active" id="tab-basic">
                    <p><strong>A Data Bottleneck</strong></p>
                    <p>Studying glassy systems requires capturing dynamics across many orders of magnitude in time. To understand both fast and slow processes, we'd ideally record at high temporal resolution. However, doing so over the enormous timescales where glasses are dynamically interesting creates a storage bottleneck.</p>
                    
                    <p><strong>Why not linear dumping?</strong></p>
                    <ul>
                        <li>Linearly-spaced dumps at high resolution generate impractical amounts of data</li>
                        <li>Low-resolution linear dumps miss fast dynamics entirely</li>
                        <li>Example (low temperature): Capturing 8 decades of time (10<sup>0</sup> to 10<sup>8</sup> timesteps) at high resolution would require ~10<sup>8</sup> frames. With 100,000 particles at ~12 bytes/particle/frame, that's ~120 TB per run. For 5 independent runs (statistical significance), you'd need ~600 TB of storage, and that's just for one temperature!</li>
                    </ul>
                    
                    <p><strong>The Geometric Solution</strong></p>
                    <p>Geometric spacing (t<sub>n</sub> = t<sub>0</sub> · r<sup>n</sup>) solves this by providing:</p>
                    <ul>
                        <li>High density at short times → captures fast dynamics</li>
                        <li>Lower density at long times → captures slow dynamics efficiently</li>
                        <li>Uniform coverage on a log-time axis</li>
                        <li>Typically ~9,000 dumps to span 8 decades with repeated sequences</li>
                        <li>Example (low temperature): Using ~9,000 dumps: 9,000 × 1.2 MB ≈ 11 GB per run, or ~55 GB for 5 runs. That's about <strong>11,000× less storage</strong> than linear dumping!</li>
                    </ul>
                    
                    <p><strong>Repeated Geometric Sequence Approach</strong></p>
                    <p>For typical analysis of equilibrated systems, we use repeated short geometric sequences. This preserves time-translation invariance (TTI) in two-time correlation measurements, allowing us to select short or long lag times (τ) without being restricted to fixed high temporal resolution.</p>
                    <p>For studying aging effects, we add a long geometric sequence during the equilibration/aging period to capture the system's evolution.</p>
                    
                    <p><strong>About This Tool</strong></p>
                    <p>This tool was created by Max Meinke and adabted for the web by Collin. It generates utility files (<code>dump_times.txt</code>, <code>run_times.txt</code>, <code>file_names.txt</code>) to be looped over in LAMMPS for saving trajectory data following this geometric dump schedule.</p>
                </div>
                
                <div class="tab-content" id="tab-technical">
                    <p><strong>Preserving Time-Translation Invariance</strong></p>
                    
                    <p>In equilibrated (quasi-stationary) systems, correlation functions depend only on the lag time:</p>
                    <div class="math-block">$$C(t, t + \tau) = C(\tau)$$</div>
                    
                    <p>This is time-translation invariance (TTI). With the approach of repeating the geometric sequences at <em>linear</em> intervals, if a sequence starts at time $t$, the next identical sequence begins at $t + \Delta$, where $\Delta$ is the fixed sequence duration:</p>
                    <div class="math-block">$$t_{\text{start}}^{(k)} = t_{\text{equil}} + k \cdot \Delta$$</div>
                    <p>This linear repetition preserves TTI: within each sequence, we can compute correlation functions at various lag times τ from the geometrically-spaced dumps, and average across sequences:</p>
                    <div class="math-block">$$C(\tau) = \langle A(t) A(t + \tau) \rangle$$</div>
                    
                    <p><strong>The Geometric Spacing</strong></p>
                    <p>Within each sequence, dumps are placed at times $t_n = t_0 \cdot r^n$, giving uniform spacing on a logarithmic axis:</p>
                    <div class="math-block">$$\log(t_n) = \log(t_0) + n\log(r)$$</div>
                    <p>This efficiently samples relaxation processes that span many decades, allowing us to measure both short and long lag times τ.</p>
                    
                    <p><strong>Capturing Aging Dynamics</strong></p>
                    <p>During aging, TTI is broken. Correlations non-negligibly depend on the waiting time $t_w$ in addition to the lag time $\tau$:</p>
                    <div class="math-block">$$C(t_w, t_w + \tau) \neq C(\tau)$$</div>
                    <p>The long geometric sequence captures this non-equilibrium regime, recording the system's evolution during equilibration.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================================
        // STORAGE & STATE
        // ============================================================
        const STORAGE_KEY = 'geom-dump-params-v4';
        let longResult = null;
        let shortResult = null;
        let dumpChart = null;
        let runChart = null;
        let shortChart = null;
        
        const defaults = {
            dt: 0.001,
            tau_equil: 200,
            tau_alpha: 10,
            total_time_long: '',
            total_time_short: '',
            dumps_per_short: 27,
            length_short: '',
            num_particles: 100000,
            long_filename_pattern: 'short<n>.dcd',
            short_filename_pattern: 'short<n>.dcd',
            theme: 'light'
        };
        
        // ============================================================
        // THEME
        // ============================================================
        
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme') || 'light';
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            updateThemeUI(next);
            localStorage.setItem('theme', next);
            updateChartsTheme();
        }
        
        function updateThemeUI(theme) {
            document.getElementById('theme-icon').innerHTML = theme === 'dark' ? '&#9788;' : '&#9790;';
            document.getElementById('theme-text').textContent = theme === 'dark' ? 'Light' : 'Dark';
        }
        
        function loadTheme() {
            const saved = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeUI(saved);
        }
        
        // ============================================================
        // EXPRESSION EVALUATOR
        // ============================================================
        
        function evaluateExpression(expr, tau_alpha, tau_equil) {
            if (expr === null || expr === undefined || expr === '') return NaN;
            
            const numVal = parseFloat(expr);
            if (!isNaN(numVal) && expr.toString().trim() === numVal.toString()) return numVal;
            
            let cleanExpr = expr.toString().trim().toLowerCase();
            cleanExpr = cleanExpr.replace(/tau_alpha/gi, '(' + tau_alpha + ')');
            cleanExpr = cleanExpr.replace(/tau_equil/gi, '(' + tau_equil + ')');
            
            if (!/^[\d\s\.\+\-\*\/\(\)]+$/.test(cleanExpr)) return NaN;
            
            try {
                const result = Function('"use strict"; return (' + cleanExpr + ')')();
                return typeof result === 'number' && isFinite(result) ? result : NaN;
            } catch (e) {
                return NaN;
            }
        }
        
        // ============================================================
        // PARAMS PERSISTENCE
        // ============================================================
        
        function saveParams() {
            const params = {
                dt: parseFloat(document.getElementById('dt').value) || defaults.dt,
                tau_equil: document.getElementById('tau_equil').value.trim() || defaults.tau_equil,
                tau_alpha: parseFloat(document.getElementById('tau_alpha').value) || defaults.tau_alpha,
                total_time_long: document.getElementById('total_time_long').value.trim(),
                total_time_short: document.getElementById('total_time_short').value.trim(),
                dumps_per_short: parseInt(document.getElementById('dumps_per_short').value) || defaults.dumps_per_short,
                length_short: document.getElementById('length_short').value.trim(),
                num_particles: parseInt(document.getElementById('num_particles').value) || defaults.num_particles,
                long_filename_pattern: document.getElementById('long_filename_pattern').value.trim() || defaults.long_filename_pattern,
                short_filename_pattern: document.getElementById('short_filename_pattern').value.trim() || defaults.short_filename_pattern
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(params));
        }
        
        function loadParams() {
            const saved = localStorage.getItem(STORAGE_KEY);
            const params = saved ? JSON.parse(saved) : defaults;
            document.getElementById('dt').value = params.dt !== undefined ? params.dt : defaults.dt;
            document.getElementById('tau_equil').value = params.tau_equil !== undefined ? params.tau_equil : defaults.tau_equil;
            document.getElementById('tau_alpha').value = params.tau_alpha !== undefined ? params.tau_alpha : defaults.tau_alpha;
            document.getElementById('total_time_long').value = params.total_time_long || '';
            document.getElementById('total_time_short').value = params.total_time_short || '';
            document.getElementById('dumps_per_short').value = params.dumps_per_short !== undefined ? params.dumps_per_short : defaults.dumps_per_short;
            document.getElementById('length_short').value = params.length_short || '';
            document.getElementById('num_particles').value = params.num_particles !== undefined ? params.num_particles : defaults.num_particles;
            document.getElementById('long_filename_pattern').value = params.long_filename_pattern || defaults.long_filename_pattern;
            document.getElementById('short_filename_pattern').value = params.short_filename_pattern || defaults.short_filename_pattern;
        }
        
        function resetParams() {
            localStorage.removeItem(STORAGE_KEY);
            loadParams();
        }
        
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('change', saveParams);
        });
        
        // ============================================================
        // UI HELPERS
        // ============================================================
        
        function toggleHelp(icon) {
            const helpContent = icon.closest('.param-group, .inline-param').querySelector('.help-content') || 
                               document.getElementById('particles-help');
            if (helpContent) {
                helpContent.classList.toggle('show');
            }
        }
        
        function toggleAdvanced() {
            const content = document.getElementById('advanced-content');
            const icon = document.getElementById('advanced-icon');
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.textContent = '[+]';
            } else {
                content.classList.add('show');
                icon.textContent = '[-]';
            }
        }
        
        function toggleExplanation(id) {
            const el = document.getElementById(id);
            el.classList.toggle('show');
        }
        
        // Modal
        function openModal() {
            document.getElementById('modal-overlay').classList.add('show');
            renderMath();
        }
        
        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
        }
        
        function closeModalOnOverlay(e) {
            if (e.target === document.getElementById('modal-overlay')) {
                closeModal();
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.modal-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            renderMath();
        }
        
        function renderMath() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false}
                    ]
                });
            }
        }
        
        // ============================================================
        // SEQUENCE GENERATION ALGORITHMS
        // ============================================================
        
        // Helper function to apply filename pattern
        function applyFilenamePattern(pattern, n) {
            return pattern.replace('<n>', n);
        }
        
        function generateLongSequence(a_lj, t_lj, n_goal, dt, c_start, m_start, filenamePattern) {
            filenamePattern = filenamePattern || 'short<n>.dcd';
            let t_start = (a_lj / dt) < 1 ? 1 : Math.round(a_lj / dt);
            const timespan = t_lj / dt;
            const r = Math.pow(timespan / t_start, 1 / (n_goal - 1));
            const n_loop = n_goal - 1;
            
            let tally = 0, meta_tally = m_start, term_counter = c_start;
            const results = { dump_times: [], run_times: [], file_names: [] };
            
            for (let counter = 0; counter <= n_loop; counter++) {
                const runtime = Math.floor(t_start * Math.pow(r, counter));
                const timestep = runtime + tally;
                if (runtime > 0) {
                    tally += runtime;
                    term_counter++;
                    results.dump_times.push(meta_tally + timestep);
                    results.run_times.push(runtime);
                    results.file_names.push(applyFilenamePattern(filenamePattern, term_counter));
                }
            }
            return results;
        }
        
        function generateShortSequence(a_lj, t_lj, n_goal, dt, c_start, m_start, repeats, filenamePattern) {
            filenamePattern = filenamePattern || 'short<n>.dcd';
            let t_start = (a_lj / dt) < 1 ? 1 : Math.round(a_lj / dt);
            const timespan = t_lj / dt;
            const r = Math.pow(timespan / t_start, 1 / (n_goal - 1));
            const n_loop = n_goal - 1;
            
            let meta_tally = m_start, term_counter = c_start;
            const results = { dump_times: [], run_times: [], file_names: [] };
            
            for (let rep = 0; rep < repeats; rep++) {
                let tally = 0, timestep = 0;
                for (let counter = 0; counter <= n_loop; counter++) {
                    timestep = Math.floor(t_start * Math.pow(r, counter));
                    const runtime = timestep - tally;
                    if (runtime > 0) {
                        tally += runtime;
                        term_counter++;
                        results.dump_times.push(meta_tally + timestep);
                        results.run_times.push(runtime);
                        results.file_names.push(applyFilenamePattern(filenamePattern, term_counter));
                    }
                }
                meta_tally += timestep;
            }
            return results;
        }
        
        function findOptimalN(tau_alpha, tau_equil, dt) {
            const target = tau_equil / dt;
            const t_lj = tau_alpha / 2;
            
            let bestN = 50, bestDiff = Infinity;
            // Search all integers from 50 to 10000
            // Use c=1, m=0 to account for LAMMPS t=0 dump taking first filename
            for (let n = 50; n <= 10000; n++) {
                const result = generateLongSequence(0, t_lj, n, dt, 1, 0);
                if (result.dump_times.length === 0) continue;
                const lastDump = result.dump_times[result.dump_times.length - 1];
                const diff = Math.abs(lastDump - target);
                if (diff < bestDiff) {
                    bestDiff = diff;
                    bestN = n;
                }
                // Early exit if we found exact match or passed target significantly
                if (diff === 0 || (lastDump > target && diff > bestDiff)) break;
            }
            return bestN;
        }
        
        // ============================================================
        // MAIN GENERATE
        // ============================================================
        
        function generate() {
            saveParams();
            
            const dt = parseFloat(document.getElementById('dt').value);
            const tau_alpha = parseFloat(document.getElementById('tau_alpha').value);
            
            if (isNaN(dt) || dt <= 0 || isNaN(tau_alpha) || tau_alpha <= 0) {
                alert('Please enter valid values for dt and tau_alpha');
                return;
            }
            
            // tau_equil can be an expression referencing tau_alpha
            let tau_equil = evaluateExpression(document.getElementById('tau_equil').value, tau_alpha, 0);
            if (isNaN(tau_equil) || tau_equil <= 0) {
                alert('Please enter a valid value for tau_equil (e.g. 200 or 100*tau_alpha)');
                return;
            }
            
            let total_time_long = evaluateExpression(document.getElementById('total_time_long').value, tau_alpha, tau_equil);
            if (isNaN(total_time_long) || total_time_long <= 0) total_time_long = tau_equil;
            
            let total_time_short = evaluateExpression(document.getElementById('total_time_short').value, tau_alpha, tau_equil);
            if (isNaN(total_time_short) || total_time_short <= 0) total_time_short = 100 * tau_alpha;
            
            const dumps_per_short = parseInt(document.getElementById('dumps_per_short').value) || 27;
            
            let length_short = evaluateExpression(document.getElementById('length_short').value, tau_alpha, tau_equil);
            if (isNaN(length_short) || length_short <= 0) length_short = 0.90 * tau_alpha;
            
            // Get filename patterns
            const longFilenamePattern = document.getElementById('long_filename_pattern').value.trim() || defaults.long_filename_pattern;
            const shortFilenamePattern = document.getElementById('short_filename_pattern').value.trim() || defaults.short_filename_pattern;
            
            // Find optimal n
            const optimal_n = findOptimalN(tau_alpha, total_time_long, dt);
            
            // Long sequence params
            // Start at c=1 because LAMMPS t=0 dump takes first filename (e.g., short1.dcd)
            // Keep m=0 so dump_time starts at 1
            const long_a = 0;
            const long_t = tau_alpha / 2;
            const long_n = optimal_n;
            const long_c = 1;  // Start file counter at 1 (first file index = 2)
            const long_m = 0;  // Start at timestep 0 (first dump_time = 1)
            const long_r = 1;
            
            longResult = generateLongSequence(long_a, long_t, long_n, dt, long_c, long_m, longFilenamePattern);
            
            // Short sequence params
            const long_last_dump = longResult.dump_times[longResult.dump_times.length - 1];
            const long_count = longResult.dump_times.length;
            
            const short_a = dt;
            const short_t = length_short;
            const short_n = dumps_per_short;
            const short_c = long_count + 1;  // Continue from long sequence, +1 for LAMMPS t=0 dump
            const short_m = long_last_dump;
            const short_r = Math.round(total_time_short / length_short);
            
            shortResult = generateShortSequence(short_a, short_t, short_n, dt, short_c, short_m, short_r, shortFilenamePattern);
            
            // Update commands
            document.getElementById('long-command').textContent = 
                `python geo-rev11.py -a ${long_a} -t ${long_t} -n ${long_n} -d ${dt} -c ${long_c} --small -r ${long_r} -m ${long_m}`;
            document.getElementById('short-command').textContent = 
                `python geo-rev11.py -a ${short_a} -t ${short_t} -n ${short_n} -d ${dt} -c ${short_c} --small --old -r ${short_r} -m ${short_m}`;
            
            // Update explanations
            document.getElementById('long-explanation').innerHTML = `
                <div class="param-line"><span class="param-name">-a ${long_a}</span> First runtime step = 0 LJ (becomes 1 timestep minimum)</div>
                <div class="param-line"><span class="param-name">-t ${long_t}</span> tau_alpha/2 = ${tau_alpha}/2 = ${long_t} LJ (controls geometric ratio)</div>
                <div class="param-line"><span class="param-name">-n ${long_n}</span> Auto-selected to get final dump closest to ${total_time_long} LJ</div>
                <div class="param-line"><span class="param-name">-d ${dt}</span> Simulation timestep</div>
                <div class="param-line"><span class="param-name">-c ${long_c}</span> File counter starts at 1 (first file = ${applyFilenamePattern(longFilenamePattern, 2)}, since LAMMPS t=0 dump uses ${applyFilenamePattern(longFilenamePattern, 1)})</div>
                <div class="param-line"><span class="param-name">--small</span> Simple geometric series mode</div>
                <div class="param-line"><span class="param-name">-r ${long_r}</span> Single sequence (no repeats)</div>
                <div class="param-line"><span class="param-name">-m ${long_m}</span> Start at timestep 0 (first dump_time = 1)</div>
            `;
            const total_time_short_input = document.getElementById('total_time_short').value.trim() || '100*tau_alpha';
            document.getElementById('short-explanation').innerHTML = `
                <div class="param-line"><span class="param-name">-a ${short_a}</span> First runtime = ${short_a} LJ = 1 timestep</div>
                <div class="param-line"><span class="param-name">-t ${short_t}</span> Short sequence duration = ${short_t.toFixed(2)} LJ</div>
                <div class="param-line"><span class="param-name">-n ${short_n}</span> Target dumps per sequence</div>
                <div class="param-line"><span class="param-name">-d ${dt}</span> Simulation timestep</div>
                <div class="param-line"><span class="param-name">-c ${short_c}</span> Continue from long sequence (index ${long_count})</div>
                <div class="param-line"><span class="param-name">--small --old</span> Geometric series with cumulative time mode</div>
                <div class="param-line"><span class="param-name">-r ${short_r}</span> Repeat ${short_r}x = ${total_time_short.toFixed(2)} LJ (${total_time_short_input}) / ${short_t.toFixed(2)} LJ</div>
                <div class="param-line"><span class="param-name">-m ${short_m}</span> Start at timestep ${long_last_dump} (end of long seq)</div>
            `;
            
            runRealityChecks(dt, tau_equil, tau_alpha, total_time_short, longFilenamePattern, shortFilenamePattern);
            updateSummary(dt);
            
            document.getElementById('btn-individual').disabled = false;
            document.getElementById('btn-stitched').disabled = false;
            
            updateDumpPlot();
            updateRunPlot();
            updateShortPlot();
            
            document.getElementById('tau-display').textContent = tau_alpha;
        }
        
        // ============================================================
        // REALITY CHECKS
        // ============================================================
        
        function runRealityChecks(dt, tau_equil, tau_alpha, total_time_short, longFilenamePattern, shortFilenamePattern) {
            const expectedLongFirst = applyFilenamePattern(longFilenamePattern, 2);
            const expectedShortFirst = applyFilenamePattern(shortFilenamePattern, longResult.dump_times.length + 2);
            const checks = [
                { name: `Long sequence first filename == ${expectedLongFirst}`, pass: longResult.file_names[0] === expectedLongFirst },
                { name: 'Long sequence first dump_time == 1', pass: longResult.dump_times[0] === 1 },
                { name: 'Long sequence first run_time == 1', pass: longResult.run_times[0] === 1 },
                { name: 'Short sequence first dump_time == long_last + 1', 
                  pass: shortResult.dump_times[0] === longResult.dump_times[longResult.dump_times.length - 1] + 1 },
                { name: `Short sequence first filename == ${expectedShortFirst}`, 
                  pass: shortResult.file_names[0] === expectedShortFirst },
                { name: 'Short sequence last dump within 1% of target', 
                  pass: Math.abs(shortResult.dump_times[shortResult.dump_times.length - 1] - (tau_equil + total_time_short) / dt) <= 0.01 * (tau_equil + total_time_short) / dt }
            ];
            
            const container = document.getElementById('reality-checks');
            container.innerHTML = '';
            checks.forEach(c => {
                const div = document.createElement('div');
                div.className = 'check-item ' + (c.pass ? 'pass' : 'fail');
                div.innerHTML = `<span class="check-icon">${c.pass ? '✓' : '✗'}</span> ${c.name}`;
                container.appendChild(div);
            });
        }
        
        // ============================================================
        // SUMMARY & FILE SIZE
        // ============================================================
        
        function formatNum(n) { return n.toLocaleString(); }
        
        function formatSize(gb) {
            if (gb < 0.001) return (gb * 1024).toFixed(2) + ' MB';
            if (gb < 1) return gb.toFixed(3) + ' GB';
            return gb.toFixed(2) + ' GB';
        }
        
        function updateSummary(dt) {
            if (!longResult || !shortResult) return;
            
            document.getElementById('long-dumps').textContent = formatNum(longResult.dump_times.length);
            document.getElementById('long-range-ts').textContent = formatNum(longResult.dump_times[0]) + ' - ' + formatNum(longResult.dump_times[longResult.dump_times.length - 1]);
            document.getElementById('long-range-lj').textContent = (longResult.dump_times[0] * dt).toFixed(4) + ' - ' + (longResult.dump_times[longResult.dump_times.length - 1] * dt).toFixed(2);
            
            document.getElementById('short-dumps').textContent = formatNum(shortResult.dump_times.length);
            document.getElementById('short-range-ts').textContent = formatNum(shortResult.dump_times[0]) + ' - ' + formatNum(shortResult.dump_times[shortResult.dump_times.length - 1]);
            document.getElementById('short-range-lj').textContent = (shortResult.dump_times[0] * dt).toFixed(2) + ' - ' + (shortResult.dump_times[shortResult.dump_times.length - 1] * dt).toFixed(2);
            
            document.getElementById('total-dumps').textContent = formatNum(longResult.dump_times.length + shortResult.dump_times.length);
            
            updateFileSizes();
        }
        
        function updateFileSizes() {
            if (!longResult || !shortResult) return;
            
            const numParticles = parseInt(document.getElementById('num_particles').value) || 100000;
            const bytesPerFrame = 12 * numParticles + 100;
            
            const longSizeGB = (bytesPerFrame * longResult.dump_times.length) / (1024 ** 3);
            const shortSizeGB = (bytesPerFrame * shortResult.dump_times.length) / (1024 ** 3);
            
            document.getElementById('long-size').textContent = formatSize(longSizeGB);
            document.getElementById('short-size').textContent = formatSize(shortSizeGB);
            document.getElementById('total-size').textContent = formatSize(longSizeGB + shortSizeGB);
        }
        
        // ============================================================
        // DOWNLOADS
        // ============================================================
        
        function downloadIndividual() {
            if (!longResult || !shortResult) return;
            const zip = new JSZip();
            
            const longFolder = zip.folder('geom-output/long-sequence');
            longFolder.file('dump_times.txt', longResult.dump_times.join('\n') + '\n');
            longFolder.file('run_times.txt', longResult.run_times.join('\n') + '\n');
            longFolder.file('file_names.txt', longResult.file_names.join('\n') + '\n');
            
            const shortFolder = zip.folder('geom-output/short-sequence');
            shortFolder.file('dump_times.txt', shortResult.dump_times.join('\n') + '\n');
            shortFolder.file('run_times.txt', shortResult.run_times.join('\n') + '\n');
            shortFolder.file('file_names.txt', shortResult.file_names.join('\n') + '\n');
            
            zip.generateAsync({ type: 'blob' }).then(content => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'geom-output.zip';
                link.click();
            });
        }
        
        function downloadStitched() {
            if (!longResult || !shortResult) return;
            const zip = new JSZip();
            const folder = zip.folder('stitched-geom-output');
            
            folder.file('stitched_dump_times.txt', [...longResult.dump_times, ...shortResult.dump_times].join('\n') + '\n');
            folder.file('stitched_run_times.txt', [...longResult.run_times, ...shortResult.run_times].join('\n') + '\n');
            folder.file('stitched_file_names.txt', [...longResult.file_names, ...shortResult.file_names].join('\n') + '\n');
            
            zip.generateAsync({ type: 'blob' }).then(content => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'stitched-geom-output.zip';
                link.click();
            });
        }
        
        // ============================================================
        // ECHARTS VISUALIZATION
        // ============================================================
        
        function getChartTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                backgroundColor: isDark ? '#1a1a1a' : '#ffffff',
                textColor: isDark ? '#e8e8e8' : '#222222',
                lineColor: isDark ? '#3d3d3d' : '#dddddd',
                longColor: '#2563eb',
                shortColor: '#dc2626',
                seqColor: '#374151',
                greenColor: '#16a34a'
            };
        }
        
        function updateChartsTheme() {
            if (longResult && shortResult) {
                updateDumpPlot();
                updateRunPlot();
                updateShortPlot();
            }
        }
        
        function updateDumpPlot() {
            if (!longResult || !shortResult) return;
            
            const theme = getChartTheme();
            const isLog = document.querySelector('input[name="dump-scale"]:checked').value === 'log';
            
            document.getElementById('dump-note').style.display = isLog ? 'block' : 'none';
            
            if (!dumpChart) {
                dumpChart = echarts.init(document.getElementById('plot-dump'));
                window.addEventListener('resize', () => dumpChart.resize());
            }
            
            const option = {
                backgroundColor: theme.backgroundColor,
                grid: { left: 60, right: 30, top: 20, bottom: 80 },
                xAxis: {
                    type: isLog ? 'log' : 'value',
                    name: 'Timesteps' + (isLog ? ' (log)' : ''),
                    nameLocation: 'middle',
                    nameGap: 30,
                    axisLine: { lineStyle: { color: theme.lineColor } },
                    axisLabel: { color: theme.textColor },
                    nameTextStyle: { color: theme.textColor }
                },
                yAxis: {
                    type: 'value',
                    min: 0, max: 1,
                    show: false
                },
                dataZoom: [
                    { type: 'inside', xAxisIndex: 0 },
                    { type: 'slider', xAxisIndex: 0, bottom: 5 }
                ],
                series: [
                    {
                        name: 'Long',
                        type: 'bar',
                        data: longResult.dump_times.map(t => [t, 1]),
                        barWidth: 1,
                        itemStyle: { color: theme.longColor }
                    },
                    {
                        name: 'Short',
                        type: 'bar',
                        data: shortResult.dump_times.map(t => [t, 1]),
                        barWidth: 1,
                        itemStyle: { color: theme.shortColor }
                    }
                ]
            };
            
            dumpChart.setOption(option, true);
        }
        
        function updateRunPlot() {
            if (!longResult || !shortResult) return;
            
            const theme = getChartTheme();
            
            if (!runChart) {
                runChart = echarts.init(document.getElementById('plot-run'));
                window.addEventListener('resize', () => runChart.resize());
            }
            
            const longData = longResult.run_times.map((v, i) => [i, v]);
            const shortData = shortResult.run_times.map((v, i) => [i + longResult.run_times.length, v]);
            
            const option = {
                backgroundColor: theme.backgroundColor,
                grid: { left: 70, right: 30, top: 20, bottom: 80 },
                xAxis: {
                    type: 'value',
                    name: 'Dump Index',
                    nameLocation: 'middle',
                    nameGap: 30,
                    axisLine: { lineStyle: { color: theme.lineColor } },
                    axisLabel: { color: theme.textColor },
                    nameTextStyle: { color: theme.textColor }
                },
                yAxis: {
                    type: 'log',
                    name: 'Run Time',
                    nameLocation: 'middle',
                    nameRotate: 90,
                    nameGap: 45,
                    axisLine: { lineStyle: { color: theme.lineColor } },
                    axisLabel: { color: theme.textColor },
                    nameTextStyle: { color: theme.textColor },
                    splitLine: { lineStyle: { color: theme.lineColor } }
                },
                dataZoom: [
                    { type: 'inside', xAxisIndex: 0 },
                    { type: 'slider', xAxisIndex: 0, bottom: 5 }
                ],
                series: [
                    {
                        name: 'Long',
                        type: 'line',
                        data: longData,
                        areaStyle: { color: 'rgba(37, 99, 235, 0.3)' },
                        lineStyle: { color: theme.longColor, width: 1 },
                        symbol: 'none'
                    },
                    {
                        name: 'Short',
                        type: 'line',
                        data: shortData,
                        areaStyle: { color: 'rgba(220, 38, 38, 0.3)' },
                        lineStyle: { color: theme.shortColor, width: 1 },
                        symbol: 'none'
                    }
                ],
                markLine: {
                    data: [{ xAxis: longResult.run_times.length }],
                    lineStyle: { color: theme.textColor, type: 'dashed' }
                }
            };
            
            runChart.setOption(option, true);
        }
        
        function findShortSequences(result, count) {
            const sequences = [];
            let start = 0;
            for (let i = 1; i < result.run_times.length; i++) {
                if (result.run_times[i] < result.run_times[i - 1] * 0.5) {
                    sequences.push(result.dump_times.slice(start, i));
                    start = i;
                    if (sequences.length >= count) break;
                }
            }
            if (sequences.length < count && start < result.dump_times.length) {
                sequences.push(result.dump_times.slice(start));
            }
            return sequences;
        }
        
        function updateShortPlot() {
            if (!longResult || !shortResult) return;
            
            const theme = getChartTheme();
            const isLog = document.querySelector('input[name="short-scale"]:checked').value === 'log';
            const dt = parseFloat(document.getElementById('dt').value);
            const tau_alpha = parseFloat(document.getElementById('tau_alpha').value);
            
            const sequences = findShortSequences(shortResult, 2);
            document.getElementById('seq-info').textContent = sequences.length > 0 ? sequences[0].length : '--';
            
            if (!shortChart) {
                shortChart = echarts.init(document.getElementById('plot-short'));
                window.addEventListener('resize', () => shortChart.resize());
            }
            
            if (sequences.length < 2) {
                shortChart.setOption({ series: [] }, true);
                return;
            }
            
            // Convert to relative LJ times
            const seq1 = sequences[0].map(t => (t - sequences[0][0]) * dt);
            const seq2 = sequences[1].map(t => (t - sequences[1][0]) * dt);
            const seq1Duration = seq1[seq1.length - 1];
            const gap = 0.5;
            const seq2Shifted = seq2.map(t => t + seq1Duration + gap);
            
            let allData1 = seq1.map(t => [t, 1]);
            let allData2 = seq2Shifted.map(t => [t, 1]);
            
            if (isLog) {
                allData1 = allData1.filter(d => d[0] > 0);
                allData2 = allData2.filter(d => d[0] > 0);
            }
            
            const option = {
                backgroundColor: theme.backgroundColor,
                grid: { left: 60, right: 30, top: 30, bottom: 80 },
                xAxis: {
                    type: isLog ? 'log' : 'value',
                    name: 'Time (LJ)' + (isLog ? ' - log' : ''),
                    nameLocation: 'middle',
                    nameGap: 30,
                    axisLine: { lineStyle: { color: theme.lineColor } },
                    axisLabel: { color: theme.textColor },
                    nameTextStyle: { color: theme.textColor }
                },
                yAxis: { type: 'value', min: 0, max: 1, show: false },
                dataZoom: [
                    { type: 'inside', xAxisIndex: 0 },
                    { type: 'slider', xAxisIndex: 0, bottom: 5 }
                ],
                series: [
                    {
                        type: 'bar',
                        data: allData1,
                        barWidth: 1,
                        itemStyle: { color: theme.seqColor },
                        markLine: {
                            silent: true,
                            symbol: 'none',
                            data: [
                                { xAxis: tau_alpha, lineStyle: { color: theme.greenColor, width: 2, type: 'solid' } },
                                { xAxis: seq1Duration + gap + tau_alpha, lineStyle: { color: theme.greenColor, width: 2, type: 'solid' } }
                            ],
                            label: { show: false }
                        }
                    },
                    {
                        type: 'bar',
                        data: allData2,
                        barWidth: 1,
                        itemStyle: { color: theme.seqColor }
                    }
                ]
            };
            
            shortChart.setOption(option, true);
        }
        
        // ============================================================
        // INIT
        // ============================================================
        
        window.onload = function() {
            loadTheme();
            loadParams();
            
            // Render math after a short delay
            setTimeout(renderMath, 500);
        };
    </script>
</body>
</html>
